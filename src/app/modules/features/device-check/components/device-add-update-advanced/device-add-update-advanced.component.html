<app-breadcrumb></app-breadcrumb>
<h3 style="color: var(--text-primary)" class="fw-bold my-3">
  {{ !deviceId ? "Th√™m m·ªõi thi·∫øt b·ªã" : "C·∫≠p nh·∫≠t thi·∫øt b·ªã" }}
</h3>
<div class="steps-header d-flex align-items-center gap-3 w-100">
  <i
    (click)="prev()"
    class="bi bi-arrow-left fs-4"
    style="cursor: pointer"
  ></i>
  <div class="progress-container flex-grow-1">
    <nz-progress
      [nzPercent]="percent"
      [nzSteps]="totalSteps"
      nzStrokeColor="#0091ea"
      [nzStrokeWidth]="10"
      [nzFormat]="formatStep"
      [nzShowInfo]="true"
    ></nz-progress>
  </div>
</div>

<!-- [nzStrokeColor]="{ direction: 'to right', '0%': '#40c4ff', '100%': '#0091ea' }" -->

<div class="wizard-container mt-4">
  <div class="summary-section">
    <h5 class="mb-3 fw-bold">K·∫øt qu·∫£ ∆∞·ªõc t√≠nh</h5>
    <div class="summary-box">
      <ng-container *ngIf="getStepSummaryKeys().length > 0; else noData">
        <div
          *ngFor="let step of getStepSummaryKeys()"
          [innerHTML]="stepSummaries[step]"
        ></div>
      </ng-container>
    </div>

    <ng-template #noData>
      <div class="d-flex align-items-center justify-content-center">
        Ch∆∞a c√≥ k·∫øt qu·∫£
      </div>
    </ng-template>
  </div>
  <div class="steps-section d-flex flex-column justify-content-between">
    <div class="steps-content">
      <div *ngIf="!isRejected">
        <div *ngIf="current === 1">
          <div class="step-title mb-3 text-muted">
            <h4 class="mb-2 fw-bold">Th√¥ng tin c∆° b·∫£n</h4>
            <span class="mb-2"> Ki·ªÉm tra th√¥ng tin c·ªßa thi·∫øt b·ªã. </span>
          </div>
          <form nz-row [nzGutter]="24" [formGroup]="deviceForm">
            <div nz-col nzSpan="24">
              <nz-form-item class="mb-2">
                <label class="w-100 text-muted mb-1">Lo·∫°i thi·∫øt b·ªã</label>
                <nz-form-control>
                  <nz-select
                    formControlName="type"
                    nzAllowClear
                    nzPlaceHolder="Ch·ªçn lo·∫°i thi·∫øt b·ªã"
                  >
                    <nz-option
                      nzValue="mobile"
                      nzLabel="ƒêi·ªán tho·∫°i"
                    ></nz-option>
                    <nz-option
                      nzValue="tablet"
                      nzLabel="M√°y t√≠nh b·∫£ng"
                    ></nz-option>
                    <nz-option nzValue="laptop" nzLabel="Laptop"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="24">
              <nz-form-item class="mb-2">
                <label class="w-100 text-muted mb-1">Model</label>
                <nz-form-control>
                  <nz-select
                    formControlName="model"
                    nzAllowClear
                    nzPlaceHolder="Ch·ªçn model"
                    (ngModelChange)="onModelChange($event)"
                  >
                    <nz-option
                      *ngFor="let opt of modelItems"
                      [nzValue]="opt.value"
                      [nzLabel]="opt.label"
                    ></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="24">
              <nz-form-item class="mb-2">
                <label class="w-100 text-muted mb-1">T√™n thi·∫øt b·ªã</label>
                <nz-form-control>
                  <nz-select
                    formControlName="deviceCode"
                    nzAllowClear
                    nzShowSearch
                    nzPlaceHolder="Ch·ªçn thi·∫øt b·ªã"
                    (ngModelChange)="onDeviceChange($event)"
                  >
                    <nz-option
                      *ngFor="let opt of devicesOptions"
                      [nzValue]="opt.value"
                      [nzLabel]="opt.label"
                    ></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>
            <div nz-col nzSpan="24">
              <nz-form-item>
                <label class="w-100 text-muted mb-1">Phi√™n b·∫£n OS</label>
                <nz-form-control>
                  <nz-input-group>
                    <input
                      nz-input
                      formControlName="osVersion"
                      placeholder="Nh·∫≠p phi√™n b·∫£n"
                    />
                  </nz-input-group>
                </nz-form-control>
              </nz-form-item>
            </div>
          </form>
        </div>

        <ng-container *ngFor="let q of questions">
          <div *ngIf="current === q.order + 1">
            <div class="step-title mb-3 text-muted">
              <h4 class="mb-2 fw-bold">
                {{ q.title || q.code }}
              </h4>
              <span class="mb-2">{{ q.question }}</span>
            </div>
            <ng-container
              *ngIf="q.code === 'FUNCTION_WEB'; else NORMAL_QUESTION"
            >
              <form
                class="step-function-list"
                [formGroup]="functionChecksForms"
              >
                <ng-container *ngFor="let item of switchItems; let i = index">
                  <app-switch-custom
                    *ngIf="canShowSwitch(i)"
                    [title]="item.label"
                    [description]="item.description"
                    [formControlName]="item.key"
                  ></app-switch-custom>
                </ng-container>
              </form>
            </ng-container>

            <ng-template #NORMAL_QUESTION>
              <form [formGroup]="additionalChecksForms">
                <app-single-select
                  [formControlName]="q.code"
                  [options]="q.deviceQuestionAnswerDtos"
                ></app-single-select>
              </form>
            </ng-template>
          </div>
        </ng-container>

        <ng-container *ngIf="current === totalSteps && resultCheck">
          <div class="result-card flex-column text-center mt-3">
            <h3 class="fw-bold">üéâ Ch√∫c m·ª´ng!</h3>
            <span class="mb-2"
              >Thi·∫øt b·ªã c·ªßa b·∫°n ƒë√£ v∆∞·ª£t qua t·∫•t c·∫£ c√°c ki·ªÉm tra.</span
            >
            <h3 class="fw-bold my-3">
              {{ (resultCheck.deviceName || "").toUpperCase() }}
            </h3>

            <nz-tag
              class="mb-2"
              [nzColor]="getTypeColor(resultCheck.finalSummary || null)"
            >
              {{ getTypeLabel(resultCheck.finalSummary) }}
            </nz-tag>

            <div style="color: #0091ea"
              >Thi·∫øt b·ªã c·ªßa b·∫°n ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ ƒë∆∞·ª£c mua l·∫°i v·ªõi gi√° ∆∞·ªõc
              t√≠nh:</div>
            
            <h2 class="fw-bold mt-2" style="color: #0091ea">
              {{
                resultCheck.price || 0 | currency : "VND" : "symbol" : "1.0-0"
              }}
            </h2>
          </div>
        </ng-container>
      </div>

      <ng-container *ngIf="isRejected">
        <div class="result-card text-center mt-3">
          <div style="font-size: 56px">üòû</div>
          <span class="fs-5"
            >Xin l·ªói! Ch√∫ng t√¥i kh√¥ng th·ªÉ mua l·∫°i thi·∫øt b·ªã n√†y.</span
          >
          <p class="text-muted mx-3">
            Do c√°c v·∫•n ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c b√°o c√°o, ch√∫ng t√¥i kh√¥ng th·ªÉ mua l·∫°i thi·∫øt b·ªã.
            B·∫°n c√≥ th·ªÉ mang ƒëi t√°i ch·∫ø ho·∫∑c gi·ªØ l·∫°i l√†m ƒëi·ªán tho·∫°i d·ª± ph√≤ng.
          </p>
        </div>
      </ng-container>
    </div>

    <div class="steps-action">
      <button
        nz-button
        nzType="primary"
        class="w-100"
        (click)="next()"
        [disabled]="!isCurrentStepValid()"
        *ngIf="current < totalSteps - 1 && !isRejected"
      >
        Ti·∫øp theo
        <i class="bi bi-arrow-right ms-2"></i>
      </button>

      <button
        nz-button
        nzType="primary"
        nzSize="large"
        class="w-100"
        (click)="submit()"
        *ngIf="current === totalSteps - 1 && !isRejected"
      >
        Ho√†n t·∫•t
      </button>

      <button
        *ngIf="isRejected"
        nz-button
        nzType="default"
        class="w-100 mb-2"
        (click)="edit()"
      >
        S·ª≠a
      </button>

      <button
        *ngIf="current === totalSteps && !isRejected"
        nz-button
        nzType="default"
        class="w-100 mb-2"
        (click)="cancel()"
      >
        Quay l·∫°i
      </button>

      <button
        *ngIf="isRejected"
        nz-button
        nzType="primary"
        class="w-100"
        (click)="startOver()"
      >
        B·∫Øt ƒë·∫ßu l·∫°i
      </button>
    </div>
  </div>
</div>
