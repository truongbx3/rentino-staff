<div class="device-modal-container">
  <div class="steps-wrapper">
    <nz-steps [nzCurrent]="currentStep" nzSize="small">
      <nz-step
        nzTitle="Thông tin cơ bản"
        nzDescription="Thông số kỹ thuật"
      ></nz-step>
      <nz-step
        nzTitle="Kiểm tra chức năng"
        nzDescription="Camera & Bổ sung"
      ></nz-step>
    </nz-steps>
  </div>

  <form nz-form [formGroup]="deviceForm" class="form-content">
    <div *ngIf="currentStep === 0">
      <h4 class="section-title">
        <i class="bi bi-phone me-2"></i>
        Thông tin cơ bản
      </h4>
      <div nz-row [nzGutter]="24">
        <div nz-col nzSpan="12">
          <nz-form-item>
            <label class="w-100 text-white mb-1">Model</label>
            <nz-form-control>
              <nz-select
                formControlName="model"
                nzAllowClear
                nzPlaceHolder="Chọn model"
                (ngModelChange)="onModelChange($event)"
              >
                <nz-option
                  *ngFor="let opt of modelItems"
                  [nzValue]="opt.value"
                  [nzLabel]="opt.label"
                ></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="12">
          <nz-form-item>
            <label class="w-100 text-white mb-1">Tên thiết bị</label>
            <nz-form-control>
              <nz-select
                formControlName="deviceName"
                nzAllowClear
                nzPlaceHolder="Chọn thiết bị"
                (ngModelChange)="onDeviceChange($event)"
              >
                <nz-option
                  *ngFor="let opt of devicesOptions"
                  [nzValue]="opt.value"
                  [nzLabel]="opt.label"
                ></nz-option>
              </nz-select>
              <!-- <input nz-input formControlName="deviceName" placeholder="iPhone 17 Pro" /> -->
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="24">
        <div nz-col nzSpan="12">
          <nz-form-item>
            <label class="w-100 text-white mb-1">Loại thiết bị</label>
            <nz-form-control>
              <nz-select
                formControlName="type"
                nzAllowClear
                nzPlaceHolder="Chọn loại thiết bị"
              >
                <nz-option nzValue="mobile" nzLabel="Điện thoại"></nz-option>
                <nz-option nzValue="tablet" nzLabel="Máy tính bảng"></nz-option>
                <nz-option nzValue="laptop" nzLabel="Laptop"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <h4 class="section-title">
        <i nz-icon nzType="setting"></i> Thông số kỹ thuật
      </h4>
      <div nz-row [nzGutter]="24">
        <div nz-col nzSpan="8">
          <nz-form-item>
            <label class="w-100 text-white mb-1">Phiên bản OS</label>
            <nz-form-control>
              <nz-input-group>
                <input nz-input formControlName="osVersion" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="8">
          <nz-form-item>
            <label class="w-100 text-white mb-1">RAM</label>
            <nz-form-control>
              <nz-input-group>
                <input nz-input formControlName="totalRam" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col nzSpan="8">
          <nz-form-item>
            <label class="w-100 text-white mb-1">Bộ nhớ</label>
            <nz-form-control>
              <nz-input-group>
                <input nz-input formControlName="storage" />
              </nz-input-group>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </div>
    <div *ngIf="currentStep === 1">
      <h4 class="section-title">Kiểm tra chức năng</h4>
      <div nz-row [nzGutter]="[24, 24]">
        <div nz-col nzSpan="6" *ngFor="let item of switchItems">
          <div
            class="switch-item"
            [class.valid]="deviceForm.get(item.key)?.value"
          >
            <span
              class="switch-label fs-6"
              [ngStyle]="{
                color: deviceForm.get(item.key)?.value ? '#4B9F53' : '#dc3545'
              }"
            >
              <i
                class="bi bi-check2-circle me-2"
                *ngIf="deviceForm.get(item.key)?.value"
              ></i>
              <i
                class="bi bi-x-circle me-2"
                *ngIf="!deviceForm.get(item.key)?.value"
              ></i>
              {{ item.label }}</span
            >
            <nz-switch [formControlName]="item.key"></nz-switch>
          </div>
        </div>
      </div>

      <h4 class="section-title mt-4">Kiểm tra Camera</h4>
      <div nz-row [nzGutter]="24">
        <div nz-col nzSpan="24">
          <nz-form-item>
            <div class="w-100 mb-1 d-flex justify-content-between">
              <label class="w-100 text-white mb-1">Camera trước</label>
              <span class="text-muted">{{ frontCameraFiles.length }}/5</span>
            </div>
            <nz-form-control>
              <nz-upload
                class="w-100"
                nzListType="picture-card"
                [(nzFileList)]="frontCameraFiles"
                [nzBeforeUpload]="beforeUploadFront"
                [nzCustomRequest]="uploadFrontCamera"
                [nzLimit]="5"
                [nzMultiple]="true"
                [nzShowUploadList]="{
                  showRemoveIcon: true
                }"
              >
                <div class="text-muted" *ngIf="frontCameraFiles.length < 5">
                  <i class="bi bi-upload fs-4"></i>
                  <div class="ant-upload-text">
                    Kéo thả hoặc chọn ảnh<br />
                    Còn {{ 5 - frontCameraFiles.length }} ảnh có thể thêm
                  </div>
                </div>
              </nz-upload>
            </nz-form-control>
          </nz-form-item>
        </div>

        <div nz-col nzSpan="24">
          <nz-form-item>
            <div class="w-100 mb-1 d-flex justify-content-between">
              <label class="w-100 text-white mb-1">Camera sau</label>
              <span class="text-muted">{{ backCameraFiles.length }}/5</span>
            </div>
            <nz-form-control>
              <nz-upload
                class="w-100"
                nzListType="picture-card"
                [(nzFileList)]="backCameraFiles"
                [nzBeforeUpload]="beforeUploadBack"
                [nzCustomRequest]="uploadBackCamera"
                [nzLimit]="5"
                [nzMultiple]="true"
                [nzShowUploadList]="{
                  showPreviewIcon: true,
                  showRemoveIcon: true
                }"
              >
                <div class="text-muted" *ngIf="backCameraFiles.length < 5">
                  <i class="bi bi-upload fs-4"></i>
                  <div class="ant-upload-text">
                    Kéo thả hoặc chọn ảnh<br />
                    Còn {{ 5 - backCameraFiles.length }} ảnh có thể thêm
                  </div>
                </div>
              </nz-upload>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <h4 class="section-title">Kiểm tra bổ sung</h4>
      <div nz-row [nzGutter]="24">
        <div nz-col nzSpan="8" *ngFor="let acc of additionalItems">
          <nz-form-item class="d-flex flex-column mt-2">
            <label class="w-100 text-white mb-1 mt-3">{{ acc.label }}</label>
            <nz-form-control>
              <nz-select class="w-100" [formControlName]="acc.key">
                <nz-option
                  *ngFor="let opt of accessoryOptions"
                  [nzValue]="opt.value"
                  [nzLabel]="opt.label"
                ></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button
        nz-button
        nzType="primary"
        nzGhost
        class="text-muted"
        (click)="cancel()"
      >
        Hủy
      </button>
      <button
        nz-button
        nzType="primary"
        nzGhost
        *ngIf="currentStep === 1"
        (click)="prev()"
      >
        <i class="bi bi-chevron-left me-2"></i>
        Quay lại
      </button>
      <button
        nz-button
        nzType="primary"
        *ngIf="currentStep === 0"
        (click)="next()"
      >
        Tiếp theo
        <i class="bi bi-chevron-right ms-2"></i>
      </button>
      <button
        nz-button
        nzType="primary"
        *ngIf="currentStep === 1"
        (click)="submit()"
      >
        <i class="bi bi-floppy me-2"></i>
        Cập nhật
      </button>
    </div>
  </form>
</div>

<ng-template #checkDeviceResult>
  <ng-container *ngIf="isSubmitting; else resultTempl">
    <div class="text-center py-5">
      <nz-spin
        nzSize="large"
        nzTip="Đang kiểm tra trạng thái thiết bị..."
      ></nz-spin>
      <div class="mt-3 text-muted">
        Vui lòng chờ trong giây lát...<br />
        <small>Quá trình có thể mất 30-90 giây</small>
      </div>
    </div>
  </ng-container>

<ng-template #resultTempl>
  <div class="result-container p-4">
    <nz-result
      *ngIf="checkResult?.code === 'device.valid'"
      nzStatus="success"
      nzTitle="Thiết bị đạt yêu cầu"
      nzSubTitle="Tất cả các hạng mục kiểm tra đều đạt"
    >
    </nz-result>
  </div>
</ng-template>
